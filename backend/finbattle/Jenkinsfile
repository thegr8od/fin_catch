pipeline {
    agent any

    tools {
        jdk 'JDK17'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                script {
                    checkout scm
                }
            }
        }

        stage('Load Credentials') {
            steps {
                // 1) Secret fileì„ Jenkinsì— ë“±ë¡í•œ IDë¡œ ê°€ì ¸ì˜¤ê¸°
                withCredentials([file(credentialsId: 'BACKEND-APPLICATION', variable: 'SECRET_FILE')]) {
                    // 2) Secret fileì„ í˜„ìž¬ workspaceì— ë³µì‚¬
                    sh 'cp "$SECRET_FILE" ./backend/finbattle/src/main/resources/'
                    // í•„ìš”í•˜ë©´ íŒŒì¼ëª… ë³€ê²½ ê°€ëŠ¥ (ì˜ˆ: secrets.env)

                    // - í•„ìš”í•˜ë©´ ë¡œê·¸ë¡œ ì°ì§€ ì•Šë„ë¡ ì£¼ì˜!
                    // - cat ./my-secrets.env ì²˜ëŸ¼ ë¯¼ê°ì •ë³´ ë…¸ì¶œí•˜ì§€ ì•Šë„ë¡ ì£¼ì˜!
                }
            }
        }

        stage('Build with Gradle') {
            steps {
                dir('backend/finbattle') {
                    sh 'chmod +x gradlew'
                    sh './gradlew clean build -x test'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dir('backend/finbattle') {
                      withCredentials([string(credentialsId: 'BACKEND_IMAGE_NAME', variable: 'BACKEND_IMAGE_NAME')]) {
                        // ì´ ë•Œ DOCKER_IMAGE_NAMEì€ "myaccount/myrepo:tag" í˜•íƒœë¼ê³  ê°€ì •
                        sh 'docker build -t ${BACKEND_IMAGE_NAME} .'
                      }
                    }
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    // 1) Docker Hubì— ë¡œê·¸ì¸
                    withCredentials([
                      usernamePassword(
                          credentialsId: 'DOCKERHUB_CREDS',
                          usernameVariable: 'DOCKER_HUB_USERNAME',
                          passwordVariable: 'DOCKER_HUB_PASSWORD'
                      ),
                      string(credentialsId: 'BACKEND_IMAGE_NAME', variable: 'BACKEND_IMAGE_NAME')
                    ]) {
                        sh """
                            docker login -u ${DOCKER_HUB_USERNAME} -p ${DOCKER_HUB_PASSWORD}
                            docker push ${BACKEND_IMAGE_NAME}
                            docker logout
                        """
                    }
                }
            }
        }

        stage('Deploy Backend') {
            steps {
                script {

                  withCredentials([
                      string(credentialsId: 'BACKEND_IMAGE_NAME', variable: 'BACKEND_IMAGE_NAME'),
                      string(credentialsId: 'BACKEND_CONTAINER_NAME', variable: 'BACKEND_CONTAINER_NAME'),
                  ]){
                      sh """
                          # ìš°ì„  ì»¨í…Œì´ë„ˆ ì¤‘ì§€/ì‚­ì œ
                          docker stop ${BACKEND_CONTAINER_NAME} || true
                          docker rm ${BACKEND_CONTAINER_NAME} || true

                          # ìµœì‹  ì´ë¯¸ì§€ë¥¼ Docker Hubì—ì„œ Pull
                          docker pull ${BACKEND_IMAGE_NAME}

                          # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                          docker run -d --name ${BACKEND_CONTAINER_NAME} --network fincatch \
                              -p 9097:9091 \
                              -v /home/ubuntu/logs:/logs \
                              -e TZ=Asia/Seoul \
                              -e JAVA_TOOL_OPTIONS="-Duser.timezone=Asia/Seoul" \
                              -e SPRING_PROFILES_ACTIVE=prod \
                              ${BACKEND_IMAGE_NAME}
                      """

                  }
                }
            }
        }
    }

    post {
        always {
            sh 'rm -f ./backend/finbattle/src/main/resources/application-secret.yml'
        }
        success {
            script {
                withCredentials([string(credentialsId: 'BACKEND_MM_WEBHOOK_URL', variable: 'BACKEND_MM_WEBHOOK_URL')]) {
                    def jsonMessage = """{
                        "attachments": [{
                            "text": "**âœ… Backend Build ì„±ê³µ**\\\\n- ìƒíƒœ: SUCCESS\\\\n- [ðŸ”— ìƒì„¸ ì •ë³´](${env.BUILD_URL})",
                            "color": "#00FF00"
                        }]
                    }"""

                    sh """
                    echo '${jsonMessage}' > mattermost_payload.json
                    cat mattermost_payload.json
                    curl -X POST -H "Content-Type: application/json" --data @mattermost_payload.json '${BACKEND_MM_WEBHOOK_URL}'
                    rm -f mattermost_payload.json
                    """
                }
            }
        }
        failure {
            script {
                withCredentials([string(credentialsId: 'BACKEND_MM_WEBHOOK_URL', variable: 'BACKEND_MM_WEBHOOK_URL')]) {
                    def jsonMessage = """{
                        "attachments": [{
                            "text": "**âŒ Backend Build ì‹¤íŒ¨**\\\\n- ìƒíƒœ: FAILURE\\\\n- [ðŸ”— ìƒì„¸ ì •ë³´](${env.BUILD_URL}/console) ",
                            "color": "#FF0000"
                        }]
                    }"""

                    sh """
                    echo '${jsonMessage}' > mattermost_payload.json
                    cat mattermost_payload.json
                    curl -X POST -H "Content-Type: application/json" --data @mattermost_payload.json '${BACKEND_MM_WEBHOOK_URL}'
                    rm -f mattermost_payload.json
                    """
                }
            }
        }
    }
}
