<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FinBattle - Chat, Game & Quiz Test</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #fff8f8; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" fill="none" stroke="%23ffcccc" stroke-width="1"><path d="M25,10 Q30,5 35,10 Q40,15 35,20 Q30,25 25,20 Q20,15 25,10 Z"/><circle cx="20" cy="40" r="3"/><circle cx="30" cy="40" r="3"/></svg>'); background-size: 100px 100px; }
    .section { border: 2px solid #ffaaaa; padding: 15px; margin-bottom: 20px; border-radius: 10px; background-color: white; box-shadow: 0 3px 6px rgba(255, 170, 170, 0.2); position: relative; }
    .section::after { content: "ğŸ¾"; position: absolute; bottom: 5px; right: 10px; opacity: 0.2; font-size: 20px; }
    .logBox { border: 1px solid #ffcccc; padding: 10px; height: 100px; overflow-y: auto; margin-top: 10px; background: #fff9f9; border-radius: 8px; }
    .statusBox { border: 1px solid #ffcccc; padding: 10px; height: 150px; overflow-y: auto; margin-top: 10px; background: #fff0f5; border-radius: 8px; }
    .userItem { margin: 5px 0; padding: 3px 8px; border-radius: 6px; background-color: #fff5f5; }
    button { padding: 5px 10px; margin: 0 5px; border-radius: 8px; cursor: pointer; background-color: #ff9999; border: none; color: white; transition: all 0.2s; }
    button:hover { background-color: #ff7777; transform: translateY(-2px); }
    input[type="text"], input[type="number"] { padding: 5px; border-radius: 6px; border: 1px solid #ffaaaa; background-color: #fffafa; }
    h1 { color: #ff6b6b; text-align: center; }
    h1::before, h1::after { content: "ğŸ±"; margin: 0 10px; }
    h2 { margin-top: 0; color: #ff6b6b; border-bottom: 2px dotted #ffdddd; padding-bottom: 5px; }
    .game-buttons { text-align: center; margin-top: 20px; padding: 10px; background-color: #fff0f5; border-radius: 10px; border: 1px dashed #ffaaaa; }
  </style>
</head>
<body>
<h1>FinBattle - Chat, Game & Quiz Test</h1>

<div class="section">
  <h2>ë°© ìƒì„±</h2>
  <label>ìƒì„±ì ID:</label> <input type="number" id="creatorUserId" placeholder="Enter Creator's User ID"/><br/><br/>
  <label>ë°© ì œëª©:</label> <input type="text" id="roomTitle" placeholder="ë°© ì œëª© ì…ë ¥"/><br/><br/>
  <label>ë¹„ë°€ë²ˆí˜¸:</label> <input type="text" id="roomPassword" placeholder="ë¹„ë°€ë²ˆí˜¸(ì˜µì…˜)"/><br/><br/>
  <label>ìµœëŒ€ ì¸ì› ìˆ˜:</label> <input type="number" id="maxPlayer" placeholder="ì˜ˆ) 4"/><br/><br/>
  <label>ë°© ìœ í˜•:</label>
  <select id="roomType">
    <option value="ONE_ON_ONE">1ëŒ€1 ë°©</option>
    <option value="MULTI">ë‹¤ì¸ì „</option>
    <option value="AI_BATTLE">AI ë°°í‹€</option>
  </select><br/><br/>
  <label>í€´ì¦ˆ ìœ í˜•:</label>
  <select id="quizType">
    <option value="FIN_KNOWLEDGE">ê¸ˆìœµ ì§€ì‹</option>
    <option value="FIN_CRIME">ê¸ˆìœµ ë²”ì£„</option>
    <option value="FIN_POLICY">ê¸ˆìœµ ì •ì±…</option>
    <option value="FIN_PRODUCT">ê¸ˆìœµ ìƒí’ˆ</option>
    <option value="FIN_INVESTMENT">ê¸ˆìœµ íˆ¬ì</option>
  </select><br/><br/>
  <button onclick="createRoom()">Create Room</button>
  <div id="createRoomResult" class="logBox"></div>
</div>

<div class="section">
  <h2>ë°© ì ‘ì†</h2>
  <label>Room ID: </label> <input type="text" id="roomId" placeholder="Enter Room ID"/>
  <label>User ID: </label> <input type="text" id="userId" placeholder="Enter Your ID"/>
  <button onclick="connect()">Connect</button>
</div>

<div class="section">
  <h2>Online Users</h2>
  <div id="userStatus" class="statusBox"></div>
</div>

<div class="section">
  <h2>ë°© ëª©ë¡ (OPEN ìƒíƒœë§Œ)</h2>
  <button onclick="loadOpenRooms()">ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
  <div id="roomList" class="logBox"></div>
</div>

<div class="section">
  <h2>Room Info</h2>
  <button onclick="requestRoomInfo()">Get Room Info</button>
  <div id="roomInfo" class="logBox"></div>
</div>

<div class="section">
  <h2>Room Controls</h2>
  <label>Target User ID to kick: </label> <input type="text" id="kickUserId" placeholder="Enter target user ID"/>
  <button onclick="kickUser()">Kick User</button><br/><br/>
  <button onclick="setReady()">I'm Ready</button>
  <div id="controlLog" class="logBox"></div>
</div>

<div class="section">
  <h2>Chat</h2>
  <label>Message: </label> <input type="text" id="chatMessage" placeholder="Type your chat message"/>
  <button onclick="sendChat()">Send Chat</button>
  <div id="chatLog" class="logBox"></div>
</div>

<div class="section">
  <h2>Quiz</h2>
  <button onclick="getQuiz()">Get Quiz Question</button>
  <button onclick="requestQuizHint()">Get Quiz Hint</button>
  <div id="quizTimer" class="logBox"></div>
  <div id="quizQuestion" class="logBox"></div><br/>
  <input type="text" id="quizAnswer" placeholder="Your Answer"/>
  <button onclick="submitQuizAnswer()">Submit Answer</button>
  <div id="quizResult" class="logBox"></div>
</div>

<div class="game-buttons">
  <button onclick="requestGameInfo()">Get Game Info</button>
  <button onclick="requestGameHint()">Request Game Hint</button>
  <button onclick="startGame()">ğŸ”¥ Start Game</button>
</div>

<div class="section">
  <h2>Game Status</h2>
  <div id="gameStatus" class="logBox">ê²Œì„ ì‹œì‘ ì „</div>
</div>

<div id="gameInfo" style="display: none;"></div>
<div id="gameHint" style="display: none;"></div>

<script>
  let stompClient = null;
  let currentUserId = null;
  let quizCountdown = 0;
  let quizTimerInterval = null;
  let gameStarted = false;
  let userScores = {};
  let currentPlayers = 0;    // í˜„ì¬ ë°©ì— ì ‘ì†í•œ í”Œë ˆì´ì–´ ìˆ˜
  // quizRoundActiveê°€ trueë©´ í˜„ì¬ í€´ì¦ˆ ë¼ìš´ë“œê°€ í™œì„± ìƒíƒœì„ (í•œ ë²ˆë§Œ ë‹¤ìŒ í€´ì¦ˆ ìš”ì²­)
  let quizRoundActive = false;

  document.addEventListener('DOMContentLoaded', function () {
    const quizAnswerInput = document.getElementById('quizAnswer');
    if (quizAnswerInput) {
      quizAnswerInput.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') submitQuizAnswer();
      });
    }
  });

  function createRoom() {
    const creatorId = document.getElementById('creatorUserId').value;
    const title = document.getElementById('roomTitle').value;
    const password = document.getElementById('roomPassword').value;
    const maxPlayer = document.getElementById('maxPlayer').value;
    const roomType = document.getElementById('roomType').value;
    const quizType = document.getElementById('quizType').value;

    if (!creatorId || !title || !maxPlayer || !roomType) {
      alert("ìƒì„±ì ID, ë°© ì œëª©, ìµœëŒ€ ì¸ì› ìˆ˜, ë°© ìœ í˜•ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
      return;
    }

    const payload = {
      memberId: parseInt(creatorId, 10),
      roomTitle: title,
      password: password,
      maxPlayer: parseInt(maxPlayer, 10),
      roomType: roomType,
      quizType: quizType
    };

    fetch('/api/room', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) })
            .then(response => { if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì—ëŸ¬: ${response.status}`); return response.json(); })
            .then(data => {
              document.getElementById('createRoomResult').innerHTML = `
          <strong>ë°© ìƒì„± ì„±ê³µ!</strong><br/>
          Room ID: ${data.roomId}<br/>
          Title: ${data.roomTitle}<br/>
          Status: ${data.status}<br/>
          RoomType: ${data.roomType}<br/>
          QuizType: ${data.quizType}<br/>
          MaxPlayer: ${data.maxPlayer}<br/>
          CreatedAt: ${data.createdAt}`;
              document.getElementById('roomId').value = data.roomId;
              document.getElementById('userId').value = creatorId;
              connect();
            })
            .catch(error => { console.error("ë°© ìƒì„± ì‹¤íŒ¨:", error); alert("ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ. ì½˜ì†” í™•ì¸."); });
  }

  function loadOpenRooms() {
    fetch('/api/room/open')
            .then(response => { if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`); return response.json(); })
            .then(rooms => {
              const roomListDiv = document.getElementById('roomList');
              roomListDiv.innerHTML = rooms.length === 0 ? '<p>í˜„ì¬ ìƒì„±ëœ OPEN ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : '';
              rooms.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.classList.add('userItem');
                roomElement.innerHTML = `
            <strong>ë°© ì œëª©:</strong> ${room.roomTitle} <br/>
            <strong>ë°© ID:</strong> ${room.roomId} <br/>
            <strong>ì¸ì›:</strong> ${room.members ? room.members.length : 0} / ${room.maxPeople} <br/>
            <strong>ìƒíƒœ:</strong> ${room.status} <br/>
            <button onclick="joinRoom(${room.roomId})">ì…ì¥</button>`;
                roomListDiv.appendChild(roomElement);
              });
            })
            .catch(error => { console.error("ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error); alert("ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜."); });
  }

  function joinRoom(roomId) {
    document.getElementById('roomId').value = roomId;
    connect();
  }

  function connect() {
    const socket = new SockJS('/ws/firechat');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
      console.log('âœ… WebSocket Connected:', frame);
      const roomId = document.getElementById('roomId').value;
      currentUserId = document.getElementById('userId').value || 'Anonymous';
      console.log(`ğŸŸ¢ êµ¬ë… ìš”ì²­: /topic/room/${roomId}`);

      stompClient.subscribe(`/topic/chat/${roomId}`, function (msg) {
        const chatMessage = JSON.parse(msg.body);
        appendLog('chatLog', `${chatMessage.sender}: ${chatMessage.content}`);
      });

      stompClient.subscribe(`/topic/room/${roomId}`, function (message) {
        const eventData = JSON.parse(message.body);
        if (eventData.event === "KICK") appendLog('controlLog', `User ${eventData.targetUserId} was kicked from room ${eventData.roomId}`);
        else if (eventData.event === "READY") appendLog('controlLog', `User ${eventData.userId} is ready!`);
        else if (eventData.event === "LEAVE") appendLog('controlLog', `User ${eventData.userId} left the room`);
        else if (eventData.event === "DELETE") appendLog('controlLog', `Room ${eventData.roomId} has been deleted`);
        else if (eventData.event === "INFO") displayRoomInfo(eventData.roomData);
      });

      stompClient.subscribe(`/topic/game/${roomId}`, function (message) {
        const gameData = JSON.parse(message.body);
        console.log("Game Message Received:", gameData);
        switch (gameData.event) {
          case "USER_STATUS":
            displayUserStatus(gameData.data);
            break;
          case "GAME_INFO":
            if (gameData.data === "IN_PROGRESS" && !gameStarted) {
              document.getElementById('gameStatus').textContent = "ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!";
              gameStarted = true;
              userScores = {};
              // ì²« í€´ì¦ˆ ìš”ì²­
              getQuiz();
            } else if (Array.isArray(gameData.data)) { // ê²Œì„ ì¢…ë£Œ ì‹œ ì‚¬ìš©ì ìƒíƒœ ìˆ˜ì‹ 
              displayGameResult(gameData.data);
              gameStarted = false;
            } else if (gameData.data !== "IN_PROGRESS") {
              document.getElementById('gameStatus').textContent = gameData.data;
              gameStarted = false;
            }
            break;
          case "QUIZ":
            document.getElementById('quizQuestion').textContent = "Question: " + gameData.data.question;
            startQuizCountdown(20);
            // ìƒˆ í€´ì¦ˆ ë¼ìš´ë“œ ì‹œì‘ ì‹œ quizRoundActiveë¥¼ trueë¡œ ì„¤ì •
            quizRoundActive = true;
            break;
          case "QUIZ_RESULT":
            // gameData.dataëŠ” { memberId: result, ... } í˜•íƒœ
            let aggregatedResults = gameData.data;
            let resultText = "Quiz Results:\n";
            for (const [uid, status] of Object.entries(aggregatedResults)) {
              resultText += `User ${uid}: ${status}\n`;
              if (status === "ì •ë‹µì…ë‹ˆë‹¤") {
                userScores[uid] = (userScores[uid] || 0) + 1;
              }
            }
            document.getElementById('quizResult').textContent = resultText;
            updateUserStatusWithScores();
            // ë§Œì•½ ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì œì¶œí–ˆê±°ë‚˜(aggregatedResults í‚¤ ìˆ˜ê°€ currentPlayersì™€ ê°™ë‹¤ë©´)
            // ê·¸ë¦¬ê³  í˜„ì¬ ë¼ìš´ë“œê°€ í™œì„± ìƒíƒœì´ë©´ ë‹¤ìŒ í€´ì¦ˆë¥¼ í•œ ë²ˆë§Œ ìš”ì²­
            if (quizRoundActive && Object.keys(aggregatedResults).length === currentPlayers) {
              quizRoundActive = false;
              setTimeout(() => getQuiz(), 2000);
            }
            break;
          case "QUIZ_HINT":
            document.getElementById('quizQuestion').textContent += ` HINT1: ${gameData.data.hint1} HINT2: ${gameData.data.hint2}`;
            break;
          default:
            console.warn("Unknown Game Event:", gameData);
        }
      });

      stompClient.onclose = function () { console.log("ğŸ”´ WebSocket ì—°ê²° ëŠì–´ì§"); };
      stompClient.send(`/app/room/${roomId}/join/${currentUserId}`, {}, {});
    });
  }

  function sendChat() {
    const roomId = document.getElementById('roomId').value;
    const content = document.getElementById('chatMessage').value;
    if (!roomId || !content || !currentUserId) return;
    const msgObj = { sender: currentUserId, content: content, roomId: roomId };
    stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify(msgObj));
    document.getElementById('chatMessage').value = '';
  }

  function requestGameInfo() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId) return;
    stompClient.send(`/app/game/${roomId}/getInfo`, {}, {});
    alert("ê²Œì„ ì •ë³´ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  function requestGameHint() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId) return;
    stompClient.send(`/app/game/${roomId}/hint`, {}, {});
    alert("ê²Œì„ íŒíŠ¸ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  function getQuiz() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId || !gameStarted) return;
    stompClient.send(`/app/game/${roomId}/getQuiz`, {}, {});
  }

  function requestQuizHint() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId) return;
    stompClient.send(`/app/game/${roomId}/quizHint`, {}, {});
  }

  function submitQuizAnswer() {
    const roomId = document.getElementById('roomId').value;
    const answer = document.getElementById('quizAnswer').value;
    if (!roomId || !answer || !currentUserId) return;
    const payload = { userAnswer: answer, memberId: currentUserId };
    stompClient.send(`/app/game/${roomId}/checkAnswer`, {}, JSON.stringify(payload));
    document.getElementById('quizAnswer').value = '';
    clearInterval(quizTimerInterval);
    document.getElementById('quizTimer').textContent = "";
  }

  function appendLog(elementId, message) {
    const logDiv = document.getElementById(elementId);
    const newLine = document.createElement('div');
    newLine.textContent = message;
    logDiv.appendChild(newLine);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function requestRoomInfo() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId) { alert("Room IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!"); return; }
    stompClient.send(`/app/room/${roomId}/info`, {}, {});
  }

  function displayRoomInfo(roomData) {
    const infoBox = document.getElementById('roomInfo');
    if (!roomData) { infoBox.innerHTML = "<strong>ë°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong>"; return; }
    let membersHTML = roomData.members && roomData.members.length > 0
            ? roomData.members.map(m => `<div> - User: ${m.memberId}, State: ${m.status}</div>`).join('')
            : "<div>(No members found)</div>";
    infoBox.innerHTML = `
      <div><strong>Room ID:</strong> ${roomData.roomId}</div>
      <div><strong>Max People:</strong> ${roomData.maxPeople}</div>
      <div><strong>Status:</strong> ${roomData.status}</div>
      <div><strong>Host:</strong> ${roomData.host ? roomData.host.memberId : 'None'}</div>
      <div><strong>Members:</strong> ${membersHTML}</div>`;
  }

  function kickUser() {
    const roomId = document.getElementById('roomId').value;
    const targetUserId = document.getElementById('kickUserId').value;
    if (!roomId || !targetUserId) { alert("Room IDì™€ Kick ëŒ€ìƒ User IDê°€ í•„ìš”í•©ë‹ˆë‹¤."); return; }
    stompClient.send(`/app/room/${roomId}/kick/${targetUserId}`, {}, {});
  }

  function setReady() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId || !currentUserId) return;
    stompClient.send(`/app/room/${roomId}/ready/${currentUserId}`, {}, {});
  }

  function startGame() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId || !currentUserId) { alert("Room IDì™€ User IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!"); return; }
    stompClient.send(`/app/game/${roomId}/start/${currentUserId}`, {}, {});
    alert("ê²Œì„ ì‹œì‘ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
  }

  function displayUserStatus(userStatusList) {
    updateUserStatusWithScores(userStatusList);
  }

  function updateUserStatusWithScores(userStatusList = null) {
    const userStatusBox = document.getElementById('userStatus');
    let statusHTML = "<h3>ğŸ”¥ Current Player Status</h3>";
    if (userStatusList && userStatusList.length > 0) {
      currentPlayers = userStatusList.length; // í˜„ì¬ í”Œë ˆì´ì–´ ìˆ˜ ì—…ë°ì´íŠ¸
      userStatusList.forEach(user => {
        const score = userScores[user.memberId] || 0;
        statusHTML += `<div>ğŸ”¹ User ID: ${user.memberId}, Life: ${user.life}, Score: ${score}</div>`;
      });
    } else {
      Object.keys(userScores).forEach(userId => {
        const score = userScores[userId];
        statusHTML += `<div>ğŸ”¹ User ID: ${userId}, Score: ${score}</div>`;
      });
    }
    userStatusBox.innerHTML = statusHTML || "<strong>í˜„ì¬ ìœ ì € ì •ë³´ ì—†ìŒ</strong>";
  }

  function displayGameResult(userList) {
    const gameStatusBox = document.getElementById('gameStatus');
    let resultHTML = "<h3>ğŸ‰ Game Over - Results</h3>";
    let maxScore = -1;
    let winnerId = null;

    userList.forEach(user => {
      const score = userScores[user.memberId] || 0;
      resultHTML += `<div>ğŸ”¹ User ID: ${user.memberId}, Life: ${user.life}, Score: ${score}</div>`;
      if (score > maxScore && user.life > 0) {
        maxScore = score;
        winnerId = user.memberId;
      }
    });

    if (winnerId) {
      resultHTML += `<div><strong>ğŸ† Winner: User ${winnerId} (Score: ${maxScore})</strong></div>`;
    } else {
      resultHTML += "<div><strong>No winner (all players out of life)</strong></div>";
    }

    gameStatusBox.innerHTML = resultHTML;
    gameStarted = false;
    clearInterval(quizTimerInterval);
    document.getElementById('quizTimer').textContent = "";
    document.getElementById('quizQuestion').textContent = "";
    document.getElementById('quizResult').textContent = "";
  }

  function startQuizCountdown(duration) {
    quizCountdown = duration;
    updateQuizTimerDisplay();
    if (quizTimerInterval) clearInterval(quizTimerInterval);
    quizTimerInterval = setInterval(function () {
      quizCountdown--;
      updateQuizTimerDisplay();
      if (quizCountdown <= 0) {
        clearInterval(quizTimerInterval);
        appendLog('quizResult', "Time's up!");
        // íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ, ë§Œì•½ í˜„ì¬ ë¼ìš´ë“œê°€ í™œì„± ìƒíƒœë¼ë©´ í•œ ë²ˆë§Œ ë‹¤ìŒ í€´ì¦ˆ ìš”ì²­
        if (quizRoundActive) {
          quizRoundActive = false;
          setTimeout(() => getQuiz(), 2000);
        }
      }
    }, 1000);
  }

  function updateQuizTimerDisplay() {
    document.getElementById('quizTimer').textContent = "Time left: " + quizCountdown + " seconds";
  }
</script>
</body>
</html>
