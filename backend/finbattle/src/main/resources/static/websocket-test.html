<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FinBattle - Chat, Game & Quiz Test</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #fff8f8;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" fill="none" stroke="%23ffcccc" stroke-width="1"><path d="M25,10 Q30,5 35,10 Q40,15 35,20 Q30,25 25,20 Q20,15 25,10 Z"/><circle cx="20" cy="40" r="3"/><circle cx="30" cy="40" r="3"/></svg>');
      background-size: 100px 100px;
    }

    .section {
      border: 2px solid #ffaaaa;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 10px;
      background-color: white;
      box-shadow: 0 3px 6px rgba(255, 170, 170, 0.2);
      position: relative;
    }

    .section::after {
      content: "ğŸ¾";
      position: absolute;
      bottom: 5px;
      right: 10px;
      opacity: 0.2;
      font-size: 20px;
    }

    .logBox {
      border: 1px solid #ffcccc;
      padding: 10px;
      height: 100px;
      overflow-y: auto;
      margin-top: 10px;
      background: #fff9f9;
      border-radius: 8px;
    }

    .statusBox {
      border: 1px solid #ffcccc;
      padding: 10px;
      height: 150px;
      overflow-y: auto;
      margin-top: 10px;
      background: #fff0f5;
      border-radius: 8px;
    }

    .userItem {
      margin: 5px 0;
      padding: 3px 8px;
      border-radius: 6px;
      background-color: #fff5f5;
    }

    button {
      padding: 5px 10px;
      margin: 0 5px;
      border-radius: 8px;
      cursor: pointer;
      background-color: #ff9999;
      border: none;
      color: white;
      transition: all 0.2s;
    }

    button:hover {
      background-color: #ff7777;
      transform: translateY(-2px);
    }

    input[type="text"],
    input[type="number"] {
      padding: 5px;
      border-radius: 6px;
      border: 1px solid #ffaaaa;
      background-color: #fffafa;
    }

    h1 {
      color: #ff6b6b;
      text-align: center;
    }

    h1::before,
    h1::after {
      content: "ğŸ±";
      margin: 0 10px;
    }

    h2 {
      margin-top: 0;
      color: #ff6b6b;
      border-bottom: 2px dotted #ffdddd;
      padding-bottom: 5px;
    }

    .game-buttons {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #fff0f5;
      border-radius: 10px;
      border: 1px dashed #ffaaaa;
    }
  </style>
</head>
<body>
<h1>FinBattle - Chat, Game & Quiz Test</h1>

<div class="section">
  <h2>ë°© ìƒì„±</h2>
  <label>ìƒì„±ì ID:</label>
  <input type="number" id="creatorUserId" placeholder="Enter Creator's User ID"/><br/><br/>
  <label>ë°© ì œëª©:</label>
  <input type="text" id="roomTitle" placeholder="ë°© ì œëª© ì…ë ¥"/><br/><br/>
  <label>ë¹„ë°€ë²ˆí˜¸:</label>
  <input type="text" id="roomPassword" placeholder="ë¹„ë°€ë²ˆí˜¸(ì˜µì…˜)"/><br/><br/>
  <label>ìµœëŒ€ ì¸ì› ìˆ˜:</label>
  <input type="number" id="maxPlayer" placeholder="ì˜ˆ) 4"/><br/><br/>
  <label>ë°© ìœ í˜•:</label>
  <select id="roomType">
    <option value="ONE_ON_ONE">1ëŒ€1 ë°©</option>
    <option value="MULTI">ë‹¤ì¸ì „</option>
    <option value="AI_BATTLE">AI ë°°í‹€</option>
  </select><br/><br/>
  <label>í€´ì¦ˆ ìœ í˜•:</label>
  <select id="quizType">
    <option value="FIN_KNOWLEDGE">ê¸ˆìœµ ì§€ì‹</option>
    <option value="FIN_CRIME">ê¸ˆìœµ ë²”ì£„</option>
    <option value="FIN_POLICY">ê¸ˆìœµ ì •ì±…</option>
    <option value="FIN_PRODUCT">ê¸ˆìœµ ìƒí’ˆ</option>
    <option value="FIN_INVESTMENT">ê¸ˆìœµ íˆ¬ì</option>
  </select><br/><br/>
  <button onclick="createRoom()">Create Room</button>
  <div id="createRoomResult" class="logBox"></div>
</div>

<div class="section">
  <h2>ë°© ì ‘ì†</h2>
  <label>Room ID: </label>
  <input type="text" id="roomId" placeholder="Enter Room ID"/>
  <label>User ID: </label>
  <input type="text" id="userId" placeholder="Enter Your ID"/>
  <button onclick="connect()">Connect</button>
</div>

<div class="section">
  <h2>Online Users</h2>
  <div id="userStatus" class="statusBox"></div>
</div>

<div class="section">
  <h2>ë°© ëª©ë¡ (OPEN ìƒíƒœë§Œ)</h2>
  <button onclick="loadOpenRooms()">ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
  <div id="roomList" class="logBox"></div>
</div>

<div class="section">
  <h2>Room Info</h2>
  <button onclick="requestRoomInfo()">Get Room Info</button>
  <div id="roomInfo" class="logBox"></div>
</div>

<div class="section">
  <h2>Room Controls</h2>
  <label>Target User ID to kick: </label>
  <input type="text" id="kickUserId" placeholder="Enter target user ID"/>
  <button onclick="kickUser()">Kick User</button>
  <br/><br/>
  <button onclick="setReady()">I'm Ready</button>
  <div id="controlLog" class="logBox"></div>
</div>

<div class="section">
  <h2>Chat</h2>
  <label>Message: </label>
  <input type="text" id="chatMessage" placeholder="Type your chat message"/>
  <button onclick="sendChat()">Send Chat</button>
  <div id="chatLog" class="logBox"></div>
</div>

<div class="section">
  <h2>Quiz</h2>
  <button onclick="getQuiz()">Get Quiz Question</button>
  <button onclick="requestQuizHint()">Get Quiz Hint</button>
  <div id="quizTimer" class="logBox"></div>
  <div id="quizQuestion" class="logBox"></div>
  <br/>
  <input type="text" id="quizAnswer" placeholder="Your Answer"/>
  <button onclick="submitQuizAnswer()">Submit Answer</button>
  <div id="quizResult" class="logBox"></div>
</div>

<div class="game-buttons">
  <button onclick="requestGameInfo()">Get Game Info</button>
  <button onclick="requestGameHint()">Request Game Hint</button>
  <button onclick="startGame()">ğŸ”¥ Start Game</button>
</div>

<div class="section">
  <h2>Game Status</h2>
  <div id="gameStatus" class="logBox">ê²Œì„ ì‹œì‘ ì „</div>
</div>

<div id="gameInfo" style="display: none;"></div>
<div id="gameHint" style="display: none;"></div>

<script>
  let stompClient = null;
  let currentUserId = null;
  let quizCountdown = 0;
  let quizTimerInterval = null;
  let gameStarted = false;
  let userScores = {};
  let currentPlayers = 0;
  let quizRoundActive = false;

  document.addEventListener('DOMContentLoaded', function () {
    const quizAnswerInput = document.getElementById('quizAnswer');
    if (quizAnswerInput) {
      quizAnswerInput.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
          submitQuizAnswer();
        }
      });
    }
  });

  function getAuthHeaders() {
    const token = localStorage.getItem('accessToken');
    return {
      'Content-Type': 'application/json',
      'Authorization': token ? `Bearer ${token}` : ''
    };
  }

  function createRoom() {
    const creatorId = document.getElementById('creatorUserId').value;
    const title = document.getElementById('roomTitle').value;
    const password = document.getElementById('roomPassword').value;
    const maxPlayer = document.getElementById('maxPlayer').value;
    const roomType = document.getElementById('roomType').value;
    const subjectType = document.getElementById('quizType').value;

    if (!creatorId || !title || !maxPlayer || !roomType) {
      alert("ìƒì„±ì ID, ë°© ì œëª©, ìµœëŒ€ ì¸ì› ìˆ˜, ë°© ìœ í˜•ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
      return;
    }

    const payload = {
      memberId: creatorId,
      roomTitle: title,
      password: password,
      maxPlayer: maxPlayer,
      roomType: roomType,
      subjectType: subjectType
    };

    fetch('/api/room', {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify(payload)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`ì„œë²„ ì‘ë‹µ ì—ëŸ¬: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      document.getElementById('createRoomResult').innerHTML = `
          <strong>ë°© ìƒì„± ì„±ê³µ!</strong><br/>
          Room ID: ${data.result.roomId}<br/>
          Title: ${data.result.roomTitle}<br/>
          Status: ${data.result.status}<br/>
          RoomType: ${data.result.roomType}<br/>
          SubjectType: ${data.result.subjectType}<br/>
          MaxPlayer: ${data.result.maxPlayer}<br/>
          CreatedAt: ${data.result.createdAt}`;
      document.getElementById('roomId').value = data.result.roomId;
      document.getElementById('userId').value = creatorId;
      connect();
    })
    .catch(error => {
      console.error("ë°© ìƒì„± ì‹¤íŒ¨:", error);
      alert("ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ. ì½˜ì†” í™•ì¸.");
    });
  }

  function connect() {
    const socket = new SockJS('/ws/firechat');
    stompClient = Stomp.over(socket);

    const token = localStorage.getItem('accessToken');
    console.log(token)

    stompClient.connect(
        {Authorization: `Bearer ${token}`},
        (frame) => {
          console.log('âœ… WebSocket Connected:', frame);
          const roomId = document.getElementById('roomId').value;
          currentUserId = document.getElementById('userId').value || 'Anonymous';

          console.log(`ğŸŸ¢ Subscribing to topics for room ${roomId}`);

          stompClient.subscribe(`/topic/chat/${roomId}`, function (msg) {
            const chatMessage = JSON.parse(msg.body);
            appendLog('chatLog', `${chatMessage.sender}: ${chatMessage.content}`);
          });

          stompClient.subscribe(`/topic/room/${roomId}`, function (message) {
            const eventData = JSON.parse(message.body);
            console.log("Room event:", eventData);
          });

          // stompClient.subscribe(`/topic/game/${roomId}`, function (message) {
          //   const gameData = JSON.parse(message.body);
          //   console.log("Game event:", gameData);
          // });

          // stompClient.onclose = function () {
          //   console.log("ğŸ”´ WebSocket ì—°ê²° ëŠì–´ì§");
          // };

          fetch(`/api/room/room/${roomId}/join`, {
            method: 'POST',
            headers: getAuthHeaders()
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`Join error: ${response.status}`);
            }
            console.log("ë°©ì— ì„±ê³µì ìœ¼ë¡œ ì…ì¥í–ˆìŠµë‹ˆë‹¤.");
          })
          .catch(error => {
            console.error("ë°© ì…ì¥ ì˜¤ë¥˜:", error);
          });
        },
        (error) => {
          console.error('âŒ STOMP Connection Error:', error);
        }
    );
  }

  function sendChat() {
    const roomId = document.getElementById('roomId').value;
    const content = document.getElementById('chatMessage').value;
    if (!roomId || !content || !currentUserId) {
      return;
    }
    const msgObj = {
      sender: currentUserId,
      content: content,
      roomId: roomId
    };
    stompClient.send(`/app/chat/${roomId}`, {}, JSON.stringify(msgObj));
    document.getElementById('chatMessage').value = '';
  }

  function loadOpenRooms() {
    fetch('/api/room/open', {headers: getAuthHeaders()})
    .then(response => {
      if (!response.ok) {
        throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
      }
      return response.json();
    })
    .then(rooms => {
      const roomListDiv = document.getElementById('roomList');
      roomListDiv.innerHTML = rooms.result.length === 0
          ? '<p>í˜„ì¬ ìƒì„±ëœ OPEN ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>'
          : '';
      rooms.result.forEach(room => {
        const roomElement = document.createElement('div');
        roomElement.classList.add('userItem');
        roomElement.innerHTML = `
              <strong>ë°© ì œëª©:</strong> ${room.roomTitle} <br/>
              <strong>ë°© ID:</strong> ${room.roomId} <br/>
              <strong>ì¸ì›:</strong> ? / ${room.maxPlayer} <br/>
              <strong>ìƒíƒœ:</strong> ${room.status} <br/>
              <button onclick="joinRoom(${room.roomId})">ì…ì¥</button>`;
        roomListDiv.appendChild(roomElement);
      });
    })
    .catch(error => {
      console.error("ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
      alert("ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜.");
    });
  }

  function joinRoom(rid) {
    document.getElementById('roomId').value = rid;
    connect();
  }

  function requestRoomInfo() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId) {
      alert("Room IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
      return;
    }
    fetch(`/api/room/room/${roomId}/info`, {
      method: 'POST',
      headers: getAuthHeaders()
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`Room info error: ${response.status}`);
      }
      alert("ë°© ì •ë³´ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ì—…ë°ì´íŠ¸ëŠ” êµ¬ë…ìœ¼ë¡œ ìˆ˜ì‹ )");
    })
    .catch(error => {
      console.error("ë°© ì •ë³´ ìš”ì²­ ì˜¤ë¥˜:", error);
    });
  }

  function kickUser() {
    const roomId = document.getElementById('roomId').value;
    const targetUserId = document.getElementById('kickUserId').value;
    if (!roomId || !targetUserId) {
      alert("Room IDì™€ Kick ëŒ€ìƒ User IDê°€ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }
    fetch(`/api/room/room/${roomId}/kick/${targetUserId}`, {
      method: 'POST',
      headers: getAuthHeaders()
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`Kick error: ${response.status}`);
      }
      alert(`User ${targetUserId} has been kicked.`);
    })
    .catch(error => {
      console.error("ê°•í‡´ ìš”ì²­ ì˜¤ë¥˜:", error);
    });
  }

  function setReady() {
    const roomId = document.getElementById('roomId').value;
    if (!roomId || !currentUserId) {
      return;
    }
    fetch(`/api/room/room/${roomId}/ready`, {
      method: 'POST',
      headers: getAuthHeaders()
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`Ready error: ${response.status}`);
      }
      alert("ì¤€ë¹„ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    })
    .catch(error => {
      console.error("ì¤€ë¹„ ìš”ì²­ ì˜¤ë¥˜:", error);
    });
  }

  function getQuiz() {
    if (!stompClient || !stompClient.connected) {
      console.log("STOMP is not connected");
      return;
    }
    const roomId = document.getElementById('roomId').value;
    stompClient.send(`/app/game/${roomId}/getQuiz`, {}, JSON.stringify({}));
  }

  function requestQuizHint() {
    const roomId = document.getElementById('roomId').value;
    stompClient.send(`/app/game/${roomId}/quizHint`, {}, JSON.stringify({}));
  }

  function submitQuizAnswer() {
    const roomId = document.getElementById('roomId').value;
    const answer = document.getElementById('quizAnswer').value;
    if (!roomId || !answer || !currentUserId) {
      return;
    }
    const payload = {userAnswer: answer, memberId: currentUserId};
    stompClient.send(`/app/game/${roomId}/checkAnswer`, {}, JSON.stringify(payload));
    document.getElementById('quizAnswer').value = '';
  }

  function requestGameInfo() {
    // ì˜ˆì‹œìš© í•¨ìˆ˜
  }

  function requestGameHint() {
    // ì˜ˆì‹œìš© í•¨ìˆ˜
  }

  function startGame() {
    const roomId = document.getElementById('roomId').value;
    fetch(`/api/room/start/${roomId}`, {
      method: 'PUT',
      headers: getAuthHeaders()
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`Start game error: ${response.status}`);
      }
      alert("ê²Œì„ ì‹œì‘ ìš”ì²­ ì „ì†¡ ì™„ë£Œ!");
    })
    .catch(error => {
      console.error("ê²Œì„ ì‹œì‘ ì˜¤ë¥˜:", error);
    });
  }

  function appendLog(elementId, message) {
    const logDiv = document.getElementById(elementId);
    const newLine = document.createElement('div');
    newLine.textContent = message;
    logDiv.appendChild(newLine);
    logDiv.scrollTop = logDiv.scrollHeight;
  }
</script>
</body>
</html>
